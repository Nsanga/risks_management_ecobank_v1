name: D√©ploiement de l'application React

on:
  push:
    branches: [main]

jobs:
  build-et-deploiement:
    runs-on: ubuntu-latest
    environment: production
    env:
      CI: false
      REACT_APP_API_URL: ${{ vars.REACT_APP_API_URL }}
    steps:
      - name: R√©cup√©rer le code depuis le d√©p√¥t
        uses: actions/checkout@v3

      - name: Configurer Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

    #   - name: Installer les d√©pendances
    #     run: npm install

    #   - name: Construire l'application
    #     run: npm run build

    #   - name: V√©rifier le contenu du dossier build local (GitHub)
    #     run: ls -la build

    #   - name: V√©rifier et cr√©er la structure des dossiers sur le serveur
    #     uses: appleboy/ssh-action@v1.0.3
    #     with:
    #       host: ${{ secrets.SERVER_IP }}
    #       username: ${{ secrets.SERVER_USER }}
    #       key: ${{ secrets.SERVER_SSH_KEY }}
    #       port: 22
    #       cipher: aes128-ctr
    #       use_insecure_cipher: true
    #       script: |
    #         echo "=== V√©rification de la structure des dossiers ==="
    #         if [ ! -d "/var/www" ]; then
    #           sudo mkdir -p /var/www
    #           echo "R√©pertoire /var/www cr√©√©"
    #         else
    #           echo "R√©pertoire /var/www existe d√©j√†"
    #         fi
    #         if [ ! -d "/var/www/frontend" ]; then
    #           sudo mkdir -p /var/www/frontend
    #           echo "R√©pertoire /var/www/frontend cr√©√©"
    #         else
    #           echo "R√©pertoire /var/www/frontend existe d√©j√†"
    #         fi
    #         if [ ! -d "/var/www/frontend/risks_management_ecobank_v1" ]; then
    #           sudo mkdir -p /var/www/frontend/risks_management_ecobank_v1
    #           echo "R√©pertoire /var/www/frontend/risks_management_ecobank_v1 cr√©√©"
    #         else
    #           echo "R√©pertoire /var/www/frontend/risks_management_ecobank_v1 existe d√©j√†"
    #         fi
    #         echo "=== Pr√©paration du dossier build ==="
    #         sudo rm -rf /var/www/frontend/risks_management_ecobank_v1/build
    #         sudo mkdir -p /var/www/frontend/risks_management_ecobank_v1/build
    #         echo "Structure des dossiers v√©rifi√©e et dossier build pr√©par√©"

    #   - name: Transf√©rer le dossier build sur le serveur
    #     uses: appleboy/scp-action@master
    #     with:
    #       host: ${{ secrets.SERVER_IP }}
    #       username: ${{ secrets.SERVER_USER }}
    #       key: ${{ secrets.SERVER_SSH_KEY }}
    #       port: 22
    #       source: "build/"
    #       target: "/var/www/frontend/risks_management_ecobank_v1/build/"
    #       strip_components: 1

    #   - name: Red√©marrer nginx
    #     uses: appleboy/ssh-action@v1.0.3
    #     with:
    #       host: ${{ secrets.SERVER_IP }}
    #       username: ${{ secrets.SERVER_USER }}
    #       key: ${{ secrets.SERVER_SSH_KEY }}
    #       port: 22
    #       cipher: aes128-ctr
    #       use_insecure_cipher: true
    #       script: |
    #         echo "=== Red√©marrage de nginx ==="
    #         sudo systemctl restart nginx
    #         echo "‚úì D√©ploiement r√©ussi !"

  notification:
    needs: build-et-deploiement
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Envoyer email de succ√®s
        # if: ${{ needs.build-et-deploiement.result == 'success' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          subject: "üéâ D√©ploiement Futuriskmanagement r√©ussi !"
          body: "üöÄ Le d√©ploiement de l'application web Futuriskmanagement a √©t√© r√©alis√© avec succ√®s. Tout fonctionne parfaitement ! üëç"
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          to: ${{ env.SMTP_TO }}
          from: ${{ env.SMTP_FROM }}

      # - name: Envoyer email d'√©chec
      #   if: ${{ needs.build-et-deploiement.result == 'failure' }}
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     subject: "‚ùå D√©ploiement Futuriskmanagement √©chou√© ‚ùå"
      #     body: "‚ö†Ô∏è Le d√©ploiement de l'application web Futuriskmanagement a √©chou√©. Veuillez v√©rifier les logs pour plus de d√©tails. üòû"
      #     username: ${{ secrets.SMTP_USERNAME }}
      #     password: ${{ secrets.SMTP_PASSWORD }}
      #     to: ${{ vars.EMAIL_TO }}
      #     from: ${{ vars.EMAIL_FROM }}
